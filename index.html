<!DOCTYPE HTML>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<style>
		body {

			width: 100vw;
			height: 100vh;
		}

		body,html,div{
			margin:	0px;
			padding: 0px;
			border:0 none;
			overflow:hidden;
		}
		canvas{
			width: 100vw;
			height: 100vh;
		}

		#yearTextField{		
			font-family:   Brush Script MT , Garamond , Georgia , Times New Roman;
			position: absolute;
			top: 10vh;
			left:0;
			width:100vw;
			text-align: center;
			color: gray;
			opacity: 0.7;
			font-size: 30vw;
			z-index: 998;
			user-select: none;
			-moz-user-select: none;
			-khtml-user-select: none;
			-webkit-user-select: none;
			-o-user-select: none;
		}

		input[type="range"] { 
			position:fixed;
			width:50vw;
			bottom:10vh;
			left:25vw;	
			z-index: 999;
			margin: auto;
			-webkit-appearance: none;			
			overflow: hidden;
			height: 2vh;			
			cursor: pointer;
			border-radius: 0; /* iOS */
		}

		::-webkit-slider-runnable-track {
			background: #DDDCB2;
		}

		/*
		 * 1. Set to 0 width and remove border for a slider without a thumb
		 */
		::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 1vw; /* 1 */
			height: 2vh;
			background: #FFFECD;
			box-shadow: -100vw 0 0 100vw #99A37A;
			border: 1vh solid #999; /* 1 */
		}

		::-moz-range-track {
			height: 2vh;
			background: #DDDCB2;
		}

		::-moz-range-thumb {
			-webkit-appearance: none;
			width: 1vw; /* 1 */
			height: 2vh;
			background: #FFFECD;
			box-shadow: -100vw 0 0 100vw #99A37A;
			border: 1vh solid #999; /* 1 */
		}
		.bubble-container{
			width: 60vw;
			margin: 0 auto;
			position: absolute;
			top:0;
			left:0;
			font-size: 5em;
		}

		.triangle-isosceles{
			position: relative;
			padding: 20px;
			margin: 1em 0 3em;
			color: #000;
			background: #DDDCB2;
			border-radius: 5px;  
		}

		.triangle-isosceles:after{
			content: "";
			position: absolute;
			bottom: -2vw;
			left:26vw;
			display:block;
			width:0;
			height: 0;
		  
			border-top: 2vw solid #DDDCB2;
		  
			border-left: 2vw solid transparent;
			border-right: 2vw solid transparent;
		  
		}
		
	</style>
	</style>
	<html class='v2' dir='ltr' xmlns='http://www.w3.org/1999/xhtml' xmlns:b='http://www.google.com/2005/gml/b'
		xmlns:data='http://www.google.com/2005/gml/data' xmlns:expr='http://www.google.com/2005/gml/expr'>

	<meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
	<title>
		澳門賣豬仔船運圖
	</title>
	<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
	<script src="https://code.createjs.com/1.0.0/tweenjs.min.js"></script>
	<script>
				createjs.MotionGuidePlugin.install();
	</script>
</head>

<body onload="init();">
	<script>
	
      
    function init(){
		var db;
		var shiparray = [];
		var counter = 0;
		//var tween;
		//var tween2;
		const DB_NAME = "culeship-indexeddb";
		const DB_VERSION =1;
		const DB_STORE_NAME = "journeys";
		const DB_INDEX = "year";
		const SHIP_TO_CANVAS_RATIO = 0.1;
    	const MACAU = {x: 1102, y: 2357};
		const TAIWAN_STRAIT = {x: 1242,y:2289};
		const JAPANSEA = {x: 1392,y:2280};
		const HAWAI = {x: 2937,y: 2459};
      	const COLLAO = {x: 4546, y: 3061 };
		const SANFRANCISCO = {x: 3617, y:1999};
		const KWIN_NYON = {x: 1021, y: 2544};
		const SOUTH_CHINA_SEA = {x: 1049, y: 2703};
		const SINGAPORE ={x: 909, y: 2803};
		const MALACCA_STRAIT={x: 834, y: 2770};
		const PENANG ={x: 776, y: 2680};
		const COLOMBA ={x: 445, y: 2740};
		const INDIAN_OCEAN1 ={x: 186, y: 2937};
		const INDIAN_OCEAN2 ={x: 0, y: 3328};
		const INDIAN_OCEAN3 ={x: 7365, y: 3328};
		const NATAL = {x: 6774, y: 3464};
		const GEORGE = {x: 6631, y: 3569};
		const CAPE_OF_GOOD_HOPE = {x: 6498, y: 3531};
		const ATLANTIC_OCEAN1 = {x: 5832, y: 3414};
		const BAIA = {x: 5376, y: 3072};
		const ST_PAUL = {x: 5548, y: 2796};
		const ATLANTIC_OCEAN2 = {x: 5121, y: 2611};
		const CARIBBEAN_SEA1 = {x: 4547, y: 2517};
		const CARIBBEAN_SEA2 = {x: 4374, y: 2374};
		const HAVANA= {x: 4456, y: 2321};
		const ADELAIDE = {x: 1592, y:3631};
		const range = document.getElementById("range");
		const yearTextField = document.getElementById("yearTextField");
		const monthTime = 1000;
		//var zoom;
		var pathe = [];
		var pathw1 = [];
		var pathw2 = [];
		var pathsf=[];
		var pathad = [];
		var pathpg = [];
		var pathmb = [];
		var pathsn = [];
		var pathjv = [];
		var pathsg=[];
		var pathml=[];
		var pathgoa=[];
		var pathcl=[];
		var pathsaigon = [];
		var pathcr = [];
		var pathreturnmacau = [];
		var pathunknown = [];
		var pathbelawan = [];
		var pathag = [];
		var pathsinkscs = [];
		
		var PATHE_RATIOS =[];
		var PATHW1_RATIOS=[];
		var PATHW2_RATIOS=[];
		var PATHSF_RATIOS=[];
		var PATHAD_RATIOS=[];
		var PATHPG_RATIOS=[];
		var PATHMB_RATIOS=[];
		var PATHSN_RATIOS=[];
		var PATHJV_RATIOS=[];
		var PATHSG_RATIOS=[];
		var PATHML_RATIOS=[];
		var PATHGOA_RATIOS=[];
		var PATHCL_RATIOS=[];
		var PATHSAIGON_RATIOS=[];
		var PATHCR_RATIOS=[];
		var PATHUNKNOWN_RATIOS=[];
		var PATHRETURNMACAU_RATIOS=[];
		var PATHBELAWAN_RATIOS=[];
		var PATHAG_RATIOS=[];
		var PATHSINKSCS=[];
		var PATHALL=[];
		
		var bitmap;
		var canvas= document.getElementById("myCanvas");
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;   
		var stage = new createjs.Stage("myCanvas");
		var image = new Image();
		image.src = "oldmap.jpg";
		image.onload = handleImageLoad;
		var ship = new Image();
		var barca = new Image();
		var galera = new Image();
		var vapor = new Image();
		var brigue = new Image();
		var lorcha = new Image();
		var escuna = new Image();
		var casetwo = new Image();
		var fire = new Image();
		var plaque = new Image();
		var fist = new Image();
		var sinkship = new Image();
		//var barcaone = new Image();
		ship.src = "ship.png";
		barca.src = "barca.png";
		galera.src = "galera.png";
		vapor.src = "vapor.png";
		brigue.src = "brigue.png";
		lorcha.src = "lorcha.png";
		escuna.src = "escuna.png";
		fire.src="fire.png";
		plaque.src ="plaque.png";
		fist.src = "fist.png";
		casetwo.src = "case2.png";
		sinkship.src = "sinkship.png";
		
		var settingValue = false;
		var evCache = new Array();//用於手勢放大
		var prevDiff = -1;
		var touchMoveTimes = 0;
		//barcaone.src = "barca1.png"
		function handleImageLoad(){
			bitmap = new createjs.Bitmap(image);
			if(canvas.width>canvas.height){
				bitmap.scaleX = canvas.width/image.width;
				bitmap.scaleY = bitmap.scaleX;
			}else{
				bitmap.scaleY = canvas.height/image.height;
				bitmap.scaleX = bitmap.scaleY;
			}
			stage.addChild(bitmap);
			stage.update();
			//var shipsvg = new createjs.Bitmap(ship);
			//var shipsvg2 = new createjs.Bitmap(ship);
			
			PATHALL.push([ //PATHALL[0]：去卡亞俄
			  MACAU.x/image.width, MACAU.y/image.height,
			  
			  TAIWAN_STRAIT.x/image.width, TAIWAN_STRAIT.y/image.height,
			  JAPANSEA.x/image.width, JAPANSEA.y/image.height,
			  
				HAWAI.x/image.width, HAWAI.y/image.height,
			  COLLAO.x/image.width, COLLAO.y/image.height,
			]);
			PATHALL.push([//PATHALL[1]：去哈瓦那第一程
			  MACAU.x/image.width, MACAU.y/image.height,
			  KWIN_NYON.x/image.width, KWIN_NYON.y/image.height,
			  SOUTH_CHINA_SEA.x/image.width, SOUTH_CHINA_SEA.y/image.height,
			  SINGAPORE.x/image.width, SINGAPORE.y/image.height,
			  MALACCA_STRAIT.x/image.width, MALACCA_STRAIT.y/image.height,
			  PENANG.x/image.width, PENANG.y/image.height,
			  COLOMBA.x/image.width, COLOMBA.y/image.height,
			  INDIAN_OCEAN1.x/image.width, INDIAN_OCEAN1.y/image.height,
			  INDIAN_OCEAN2.x/image.width, INDIAN_OCEAN2.y/image.height,
			]);
			PATHALL.push([//PATHALL[2]：去哈瓦那第二程
			  INDIAN_OCEAN3.x/image.width, INDIAN_OCEAN3.y/image.height,
			  NATAL.x/image.width, NATAL.y/image.height,
			  GEORGE.x/image.width, GEORGE.y/image.height,
			  CAPE_OF_GOOD_HOPE.x/image.width, CAPE_OF_GOOD_HOPE.y/image.height,
			  ATLANTIC_OCEAN1.x/image.width, ATLANTIC_OCEAN1.y/image.height,
			  BAIA.x/image.width, BAIA.y/image.height,
			  ST_PAUL.x/image.width, ST_PAUL.y/image.height,
			  ATLANTIC_OCEAN2.x/image.width, ATLANTIC_OCEAN2.y/image.height,
			  CARIBBEAN_SEA1.x/image.width, CARIBBEAN_SEA1.y/image.height,
			  CARIBBEAN_SEA2.x/image.width, CARIBBEAN_SEA2.y/image.height,
			  HAVANA.x/image.width, HAVANA.y/image.height,
			]);
			PATHALL.push([//PATHALL[3]：去舊金山
				MACAU.x/image.width, MACAU.y/image.height,
			  
				TAIWAN_STRAIT.x/image.width, TAIWAN_STRAIT.y/image.height,
				
				SANFRANCISCO.x/image.width, SANFRANCISCO.y/image.height,
			]);
			PATHALL.push([//PATHALL[4]：去阿德雷德
				MACAU.x/image.width, MACAU.y/image.height,
				1262/image.width, 2403/image.height,
				1930/image.width, 3741/image.height,
				1608/image.width, 3685/image.height,
				ADELAIDE.x/image.width, ADELAIDE.y/image.height,
			]);
			PATHALL.push([//PATHALL[5]：去檳城
				MACAU.x/image.width, MACAU.y/image.height,
				KWIN_NYON.x/image.width, KWIN_NYON.y/image.height,
				SOUTH_CHINA_SEA.x/image.width, SOUTH_CHINA_SEA.y/image.height,
				SINGAPORE.x/image.width, SINGAPORE.y/image.height,
				MALACCA_STRAIT.x/image.width, MALACCA_STRAIT.y/image.height,
				PENANG.x/image.width, PENANG.y/image.height,
				786/image.width, 2652/image.height,
			]);
			PATHALL.push([//PATHALL[6]：去莫桑比克,只寫了第二段
				INDIAN_OCEAN3.x/image.width, INDIAN_OCEAN3.y/image.height,
				7014/image.width, 3405/image.height,
				6875/image.width, 3218/image.height,
			]);
			PATHALL.push([//PATHALL[7]：去蘇利南,只寫了第二段
				INDIAN_OCEAN3.x/image.width, INDIAN_OCEAN3.y/image.height,
				NATAL.x/image.width, NATAL.y/image.height,
				GEORGE.x/image.width, GEORGE.y/image.height,
				CAPE_OF_GOOD_HOPE.x/image.width, CAPE_OF_GOOD_HOPE.y/image.height,
				ATLANTIC_OCEAN1.x/image.width, ATLANTIC_OCEAN1.y/image.height,
				BAIA.x/image.width, BAIA.y/image.height,				
				4780/image.width, 2605/image.height,
			]);
			PATHALL.push([//PATHALL[8]：去爪哇
				MACAU.x/image.width, MACAU.y/image.height,
				KWIN_NYON.x/image.width, KWIN_NYON.y/image.height,
				SOUTH_CHINA_SEA.x/image.width, SOUTH_CHINA_SEA.y/image.height,
				SINGAPORE.x/image.width, SINGAPORE.y/image.height,
				1031/image.width, 2951/image.height,
			]);
			PATHALL.push([//PATHALL[9]：去新加坡
				MACAU.x/image.width, MACAU.y/image.height,
				KWIN_NYON.x/image.width, KWIN_NYON.y/image.height,
				SOUTH_CHINA_SEA.x/image.width, SOUTH_CHINA_SEA.y/image.height,
				SINGAPORE.x/image.width, SINGAPORE.y/image.height,
				911/image.width, 2803/image.height,
			]);
			PATHALL.push([//PATHALL[10]：去馬尼拉
				MACAU.x/image.width, MACAU.y/image.height,
				1133/image.width, 2448/image.height,
				1225/image.width, 2531/image.height,
			]);
			PATHALL.push([//PATHALL[11]：去果亞
				MACAU.x/image.width, MACAU.y/image.height,
				KWIN_NYON.x/image.width, KWIN_NYON.y/image.height,
				SOUTH_CHINA_SEA.x/image.width, SOUTH_CHINA_SEA.y/image.height,
				SINGAPORE.x/image.width, SINGAPORE.y/image.height,
				MALACCA_STRAIT.x/image.width, MALACCA_STRAIT.y/image.height,
				PENANG.x/image.width, PENANG.y/image.height,
				COLOMBA.x/image.width, COLOMBA.y/image.height,
				265/image.width, 2598/image.height,
				265/image.width, 2497/image.height,
			]);
			PATHALL.push([//PATHALL[12]：去詩蘭
				MACAU.x/image.width, MACAU.y/image.height,
				KWIN_NYON.x/image.width, KWIN_NYON.y/image.height,
				SOUTH_CHINA_SEA.x/image.width, SOUTH_CHINA_SEA.y/image.height,
				SINGAPORE.x/image.width, SINGAPORE.y/image.height,
				MALACCA_STRAIT.x/image.width, MALACCA_STRAIT.y/image.height,
				PENANG.x/image.width, PENANG.y/image.height,
				COLOMBA.x/image.width, COLOMBA.y/image.height,
			]);
			PATHALL.push([//PATHALL[13]：去西貢
				MACAU.x/image.width, MACAU.y/image.height,
				1058/image.width, 2557/image.height,
				1008/image.width, 2606/image.height,
			]);
			PATHALL.push([//PATHALL[14]：去哥斯達黎加
			  MACAU.x/image.width, MACAU.y/image.height,
			  
			  TAIWAN_STRAIT.x/image.width, TAIWAN_STRAIT.y/image.height,
			  JAPANSEA.x/image.width, JAPANSEA.y/image.height,
			  
				HAWAI.x/image.width, HAWAI.y/image.height,
			  4413/image.width, 2641/image.height,
			]);
			PATHALL.push([//PATHALL[15]：去未知地方
				MACAU.x/image.width, MACAU.y/image.height,
				1272/image.width, 2415/image.height,
				1573/image.width, 2476/image.height,
			]);
			PATHALL.push([//PATHALL[16]：折返澳門
				MACAU.x/image.width, MACAU.y/image.height,
				1226/image.width, 2361/image.height,
				1204/image.width, 2452/image.height,
				1103/image.width, 2484/image.height,
				1061/image.width, 2432/image.height,
				1072/image.width, 2383/image.height,
				MACAU.x/image.width, MACAU.y/image.height,
			]);
			PATHALL.push([//PATHALL[17]：不老灣
				MACAU.x/image.width, MACAU.y/image.height,
				KWIN_NYON.x/image.width, KWIN_NYON.y/image.height,
				SOUTH_CHINA_SEA.x/image.width, SOUTH_CHINA_SEA.y/image.height,
				SINGAPORE.x/image.width, SINGAPORE.y/image.height,
				MALACCA_STRAIT.x/image.width, MALACCA_STRAIT.y/image.height,
				PENANG.x/image.width, PENANG.y/image.height,
				801/image.width,  2745/image.height,
			]);
			PATHALL.push([//PATHALL[18]：安直港
				1031/image.width, 2951/image.height,
				612/image.width,  3030/image.height,
				INDIAN_OCEAN2.x/image.width, INDIAN_OCEAN2.y/image.height,
			]);
			PATHALL.push([//PATHALL[19]：南中國海沉沒
				MACAU.x/image.width, MACAU.y/image.height,
				1089/image.width, 2951/image.height,
				1131/image.width, 2567/image.height,
			]);
			
			//console.log("PATHE_RATIOS: "+PATHE_RATIOS.toString());
		}

		if (!window.indexedDB) {
			window.alert("抱歉，你的瀏覽器無法支援土地公收藏架。敬請使用其他瀏覽器。");
			
		}else{
			//window.alert("瀏覽器通過測試。");
			loadJson();
			
		}
		async function loadJson() {
		  const requestURL = 'jsonship_v1.json';//注意,有時瀏覽器會自行取舊的檔案,所以每次更新,應順便更新v後的數字，迫瀏覽器重新取檔案。
		  const request = new Request(requestURL);
		  const response = await fetch(request);
		  const jsonship = await response.json();
		  //console.log(jsonship);
		  //deleteDB(jsonship);
		  openDb(jsonship);
		}
		function deleteDB(jsonship){//已經不用的程式碼，用於手動地清除DB
				var DBDeleteRequest = window.indexedDB.deleteDatabase(DB_NAME);
				//var request = objectStore.clear();
				DBDeleteRequest.onblocked = function(event) {
					 console.log("Error message: Database in blocked state. ");
				};
				DBDeleteRequest.onerror = function(event) {
				  console.log("Error deleting database.");
				};

				DBDeleteRequest.onsuccess = function(event) {
				  console.log("Database deleted successfully");
					openDb(jsonship);
				  //console.log(request.result); // should be null
				};
		}

		function openDb(jsonship) {
			var req = indexedDB.open(DB_NAME, DB_VERSION);
			req.onsuccess = function (evt) {
				db = this.result;
				//var transaction = db.transaction(DB_STORE_NAME, 'readonly');
				//var objectStore = transaction.objectStore(DB_STORE_NAME);
				var transaction = db.transaction(DB_STORE_NAME, 'readwrite');
				var objectStore = transaction.objectStore(DB_STORE_NAME);
				for (i = 0; i < jsonship.jsonship.length; i++) { 
					console.log(jsonship.jsonship[i]);
					objectStore.put(jsonship.jsonship[i]);
				}
				getMaxMinNumber();
				createjs.Ticker.timingMode = createjs.Ticker.RAF;
				createjs.Ticker.on("tick", tick);
				
			};
			req.onerror = function (evt) {
			  console.error("openDb:", evt.target.errorCode);
			};

			req.onupgradeneeded = function (evt) {

				
				
				var objectStore = evt.target.result.createObjectStore(DB_STORE_NAME, {autoIncrement: true});
				
				objectStore.createIndex(DB_INDEX, DB_INDEX, { unique: false });
				objectStore.createIndex("id", "id", { unique: true });
			};
		}
		
		/*
		shiparray.push(shipsvg);
		shiparray.push(shipsvg2);
		//shipsvg.image = ship;
		
		//stageY = ;
		stage.addChild(bitmap);
		stage.addChild(shipsvg);
		stage.addChild(shipsvg2);
		getFixScale(shipsvg, SHIP_TO_CANVAS_RATIO);
		getFixScale(shipsvg2, SHIP_TO_CANVAS_RATIO);
		shipsvg.regX = 122;
		shipsvg.regY = 112;
		shipsvg2.regX = 122;
		shipsvg2.regY = 112;
		*/

		
				//shipsvg.x = MACAU.x;
		//shipsvg.y = MACAU.y;
		//stage.update();	
		//handleResize();
		createjs.Touch.enable(stage);
		canvas.addEventListener("mousewheel", MouseWheelHandler, false);
		canvas.addEventListener("DOMMouseScroll", MouseWheelHandler, false);

		function MouseWheelHandler(e) {
		
			if (e.cancelable) {
					try{
						e.preventDefault();
					}catch (error){
						 console.log("error in ev.preventDefault: "+error);
					}
			}
			const { ctrlKey } = e
			/*if (ctrlKey) {
				e.preventDefault();
			}*/
			if(Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)))>0){
				var zoom = 1.1;
				
			}else{
				var zoom = 0.9;
				
			}
			doZoom(zoom);
		}
		function doZoom(zoom){
			var local = stage.globalToLocal(stage.mouseX, stage.mouseY);
			stage.regX=local.x;
			
			stage.x=stage.mouseX;
				
			
			if(zoom>1){
				
				
				stage.regY=local.y;
				stage.y=stage.mouseY;
			}else{
				var tmpHeight = image.height*stage.scaleY*bitmap.scaleY*0.9;
				if(tmpHeight>canvas.height){
									
						stage.regY=local.y;
						stage.y=stage.mouseY;
							
					
				}else{
					zoom=1;
					stage.y=0;
					stage.regY=0;
					//stage.scaleY = bitmap.scaleY;
				}
			}
			stage.scaleX=stage.scaleY*=zoom;
			for (var i = 0; i < shiparray.length ; i++){
				//console.log("shiparray: "+shiparray[i]);
				getFixScale(shiparray[i].shipsvg, SHIP_TO_CANVAS_RATIO);
			}
			stage.update();
		}
		function getFixScale(obj, s){
			var tmpImg = obj.getChildAt(0).image;
			obj.scaleX = s * canvas.width / ( obj.parent.scaleX * tmpImg.width );
			obj.scaleY = obj.scaleX;
			console.log("obj.scaleX: "+ obj.scaleX );
		}
		
		canvas.addEventListener("pointerdown", function(e){
			evCache.push(e);
			var p = stage.globalToLocal(stage.mouseX, stage.mouseY);
			
			var offset={x:stage.x-p.x,y:stage.y-p.y};	
			var beforeScreen = {x: e.screenX, y:e.screenY};
			console.log("pointerDown", e);
			console.log("stage.x: " + stage.x+", "+"stage.y: " + stage.y);
			console.log("p.x: " + p.x+", "+"p.y: " + p.y);
			console.log("offset.x: "+offset.x +", offset.y:"+ offset.y);
			console.log("stage.mouseX: "+stage.mouseX+", stage.mouseY:"+stage.mouseY);
			canvas.addEventListener("pointerup",pointerup_handler);
			canvas.addEventListener("pointercancel",pointerup_handler);
			canvas.addEventListener("pointerleave",pointerup_handler);
			canvas.addEventListener("pointerout",pointerup_handler);
			canvas.addEventListener("pointermove", pointermove_handler);
			canvas.addEventListener("pressmove", pointermove_handler);
			//setInterval(pointermove_handler, 500);
			function pointermove_handler(ev){
				if (ev.cancelable) {
					try{
						ev.preventDefault();
					}catch (error){
						 console.log("error in ev.preventDefault: "+error);
					}
				}
				touchMoveTimes++;
				 //console.log("pointerMove", ev);
				 
				 // Find this event in the cache and update its record with this event
				 for (var i = 0; i < evCache.length; i++) {
				   if (ev.pointerId == evCache[i].pointerId) {
					  evCache[i] = ev;
				   break;
				   }
				 }

				 // If two pointers are down, check for pinch gestures
				 if (evCache.length >= 2) {
				   // Calculate the distance between the two pointers
				   var curDiff = Math.sqrt(Math.pow(evCache[0].screenX - evCache[1].screenX, 2)+Math.pow(evCache[0].screenY - evCache[1].screenY, 2));
					var zoom =curDiff/prevDiff;
					//console.log("touchMoveTimes: "+ touchMoveTimes+ "; zoom: " + zoom +"; curDiff: "+curDiff+"; prevDiff: "+prevDiff);
					
				   if (prevDiff > 0) {
					doZoom(zoom);
					 /*if (curDiff > prevDiff) {
					   // The distance between the two pointers has increased
					   console.log("Pinch moving OUT -> Zoom in", ev);
					   ev.preventDefault();
						
					 }
					 if (curDiff < prevDiff) {
						ev.preventDefault();
					   // The distance between the two pointers has decreased
					   console.log("Pinch moving IN -> Zoom out",ev);

					 }*/
				   }

				   // Cache the distance for the next move event
				   prevDiff = curDiff;
				 }else{
					if(true){
						stage._updatePointerPosition(stage.id, e, stage.pageX, stage.pageY);
						var tmpP = stage.globalToLocal(stage.mouseX, stage.mouseY);
						stage.x = tmpP.x+offset.x;
						var tmpY = tmpP.y+offset.y;
						stage.y = tmpY;
						

						console.log("pointerMove", ev);
						console.log("stage.x: " + stage.x+", "+"stage.y: " + stage.y);
						console.log("tmpP.x: " + tmpP.x+", "+"tmpP.y: " + tmpP.y);
						console.log("stage.mouseX: "+stage.mouseX+", stage.mouseY:"+stage.mouseY);
						stage.update();	
					}
				 }
			 }
			function pointerup_handler(ev) {
			  //console.log(ev.type, ev);
			  canvas.removeEventListener("pointermove", pointermove_handler);
			  canvas.removeEventListener("pressmove", pointermove_handler);
			   //clearInterval(pointermove_handler);
			  // Remove this pointer from the cache and reset the target's
				
				for (var i = 0; i < evCache.length; i++) {
				   if (evCache[i].pointerId == ev.pointerId) {
					 evCache.splice(i, 1);
					 break;
				   }
				 }


			  // If the number of pointers down is less than two then reset diff tracker
			  if (evCache.length < 2) {
				prevDiff = -1;
			  }
			}
			
		});
		window.addEventListener("resize", handleResize, false);
		/*stage.addEventListener("stagemousedown", function(e) {			
				var offset={x:stage.x-e.stageX,y:stage.y-e.stageY};			
			stage.addEventListener("stagemousemove",function(ev) {			
					stage.x = ev.stageX+offset.x;
					var tmpY = ev.stageY+offset.y;
					stage.y = tmpY;
					stage.update();				
			});
			stage.addEventListener("stagemouseup", function(){				
				stage.removeAllEventListeners("stagemousemove");

			});
		}); */
		
		
		
		function tick(event) {
		  stage.update(event);		  
		}
		function handleResize(event) {
				console.log("resized");
				  var w = window.innerWidth,
					  h = window.innerHeight;
				  var pos = 0;
				  stage.canvas.width = w;
				  stage.canvas.height = h;
				  
				  //var pos = tween ? tween.rawPosition : 0;//如果tween是true, pos 會等於tween.rawPosition，否則會等於０。　？是條件 (三元) 運算子
				  //var pos2 = tween2 ? tween2.rawPosition : 0;
				  //createjs.Tween.removeTweens(shipsvg);
				  //createjs.Tween.removeTweens(shipsvg2);
				  // Make a new path using the width/height ratios
				  /*pathe.length = 0;
				  pathw1.length = 0;
				  pathw2.length = 0;
				  pathsf.length = 0;
				  pathad.length = 0;
				  pathpg.length = 0;
				   pathmb.length = 0;
				   pathsn.length = 0;
				   pathjv.length =0;
				   pathsg.length=0;
				   pathml.length=0;
				   pathgoa.length=0;
				   pathcl.length=0;
				   pathsaigon.length=0;
				   pathcr.length=0;
				   pathunknown.length=0;
				   pathreturnmacau.length=0;
				   pathbelawan.length=0;
				   pathag.length=0;*/
					var tmppath=[];
					//var tmppathall = PATHALL;
					PATHALL.forEach(function(item){
						//console.log("Array.isArray(item): "+Array.isArray(item));
						//var tmppathpoints =new Array(item);
						//console.log("tmppathpoints: "+tmppathpoints);
						var tmpathnewpoints = [];
						for(var i=0; i<item.length;i+=2){
							//console.log("item[i]: "+item[i+1]);
							tmpathnewpoints.push(
								item[i]* image.width * bitmap.scaleX, 
								item[i+1]* image.height * bitmap.scaleY,	
							);
							//console.log("tmppathnewpoints: "+tmpathnewpoints.toString());
						}
						
						tmppath.push(tmpathnewpoints);
						//console.log("tmppath: "+tmppath.length);
					});
				
				//console.log("PATHE_RATIOS: "+PATHE_RATIOS.toString());
				//console.log("image.width: "+image.width);
				//console.log("bitmap.scaleX: "+bitmap.scaleX);
				//console.log("bitmap.scaleY: "+bitmap.scaleY);
				//console.log("pathe: "+ pathe.toString());
				for (var i=0; i<shiparray.length; i++){
					createjs.Tween.removeTweens(shiparray[i].shipsvg);
					shiparray[i].shipsvg.rotation = 0;
					
					var pos = shiparray[i].tween ? shiparray[i].tween.rawPosition : 0;
					var month = shiparray[i].month ? shiparray[i].month*monthTime : i*monthTime/20;
					
					var journeyTimeE = monthTime*4;
					if(shiparray[i].month<=3 || shiparray[i].month>=10){
						var journeyTimeW = monthTime*4.9 / 2;
						var journeyTimeJV = monthTime;
						var journeyTimeSG = monthTime*0.6;
						var journeyTimeGOA = monthTime*1.5;
					}else{
						var journeyTimeW = monthTime*6 / 2;
						var journeyTimeJV = monthTime*2;
						var journeyTimeSG = monthTime*1.5;
						var journeyTimeGOA = monthTime*2.3;
					}
					if(shiparray[i].specialcase==2){//處理不同的事件
						journeyTimeW = monthTime*7.7;
					}
					
					switch(shiparray[i].destination ? shiparray[i].destination : 0){
						case "哈瓦那":							
						case "古巴":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({ alpha: 0 } ).wait(month).to({ alpha: 1 } ).to({guide: {path: tmppath[1]}},journeyTimeW).to({guide: {path: tmppath[2]}},journeyTimeW).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "卡亞俄":
						case "秘魯":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({ alpha: 0 } ).wait(month).to({ alpha: 1 } ).to({guide: {path: tmppath[0], orient: "auto"}},journeyTimeE).to({ alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							shiparray[i].shipsvg.getChildAt(0).scaleX = -1* Math.abs(shiparray[i].shipsvg.getChildAt(0).scaleX);
							break;
						case "舊金山":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({ alpha: 0 } ).wait(month).to({ alpha: 1 } ).to({guide: {path: tmppath[3], orient: "auto"}},journeyTimeE).to({ alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							shiparray[i].shipsvg.getChildAt(0).scaleX = -1* Math.abs(shiparray[i].shipsvg.getChildAt(0).scaleX);
							break;
						case "阿德雷德":
						
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[4], orient: "auto"}},monthTime*1.5).to({ alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							shiparray[i].shipsvg.getChildAt(0).scaleX = -1* Math.abs(shiparray[i].shipsvg.getChildAt(0).scaleX);
							break;
						case "檳城":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[5]}},journeyTimeW).to( { alpha: 0 }, monthTime ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "莫桑比克":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path:  tmppath[1]}},journeyTimeW).to({guide: {path: tmppath[6]}},monthTime/2).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "蘇利南":
						case "德梅拉拉":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[1]}},journeyTimeW).to({guide: {path: tmppath[7]}},journeyTimeW*0.8).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "爪哇":
						case "巴達維亞":
						case "巴達維亞和三寶瓏":

							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[8]}},journeyTimeJV).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "新加坡":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[9]}},journeyTimeSG).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "馬尼拉":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[10]}},monthTime*0.6).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							shiparray[i].shipsvg.getChildAt(0).scaleX = -1* Math.abs(shiparray[i].shipsvg.getChildAt(0).scaleX);
							break;
						case "果亞":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[11]}},journeyTimeGOA).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "詩蘭":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[12]}},journeyTimeGOA).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "西貢":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[13]}},monthTime*0.7).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "哥斯達黎加":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[14], orient: "auto"}},journeyTimeE).to({ alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							shiparray[i].shipsvg.getChildAt(0).scaleX = -1* Math.abs(shiparray[i].shipsvg.getChildAt(0).scaleX);
							break;
						case "澳門":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({ alpha: 0 } ).wait(month).to({ alpha: 1 } ).to({guide: {path: tmppath[16]}},monthTime).to({ alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							
							shiparray[i].tween.setPosition(pos);
							shiparray[i].shipsvg.getChildAt(0).scaleX = -1* Math.abs(shiparray[i].shipsvg.getChildAt(0).scaleX);
							break;
						case "不老灣":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({ alpha: 0 } ).wait(month).to({ alpha: 1 } ).to({guide: {path: tmppath[17]}},monthTime).wait(monthTime/2).call(showfist, [shiparray[i]], this).to({ alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "經安直港":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[8]}},journeyTimeJV).call(showfist, [shiparray[i]], this).wait(monthTime/3).to({guide: {path: tmppath[18]}},monthTime).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						case "南中國海沉沒":
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path: tmppath[19]}},monthTime).call(sink, [shiparray[i]], this).wait(monthTime/4).to( { alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							shiparray[i].tween.setPosition(pos);
							break;
						default:
							shiparray[i].tween = createjs.Tween.get(shiparray[i].shipsvg).to({alpha:0}).wait(month).to({alpha:1}).to({guide: {path:tmppath[15], orient: "auto"}},monthTime).to({ alpha: 0 }, 1000 ).call(arrival, [shiparray[i].counter], this);
							
							shiparray[i].tween.setPosition(pos);
							break;
					}
					 
					
				}

			 
		 }
		 function arrival(counterNum, obj){
			//console.log("arrival: "+counterNum);
			for(let i=0; i<shiparray.length;i++){
				if(counterNum == shiparray[i].counter){
				
					stage.removeChild(shiparray[i].shipsvg);
					shiparray.splice(i, 1);
					//console.log("shiparray.length: "+shiparray.length);
					break;
				}
			}
		 }
		 function showfist(array, obj){
			//for(let i=0; i<shiparray.length;i++){
				//if(counterNum == shiparray[i].counter){
					array.casebitmap = new createjs.Bitmap(fist);									
					array.casebitmap.regX = array.shipbitmap.image.width/2;
					array.casebitmap.regY = 300;
					array.shipsvg.addChild(array.casebitmap);
					createjs.Tween.get(array.casebitmap).to({alpha:0}, 3000);
				//}
			//}
		 }
		 function sink(array, obj){
			array.casebitmap = new createjs.Bitmap(sinkship);
			array.casebitmap.regX = array.shipbitmap.regX;
			array.casebitmap.regY = array.shipbitmap.regY;
			array.shipbitmap.alpha = 0;
			array.shipsvg.addChild(array.casebitmap);
		 }
		

		
		
		function getMaxMinNumber (callback) {
			var tmpOpenReq = indexedDB.open(DB_NAME);
			tmpOpenReq.onsuccess = function() {
				var tmpDb = tmpOpenReq.result;
				var tmpTransaction = tmpDb.transaction(DB_STORE_NAME, 'readonly');
				var tmpObjectStore = tmpTransaction.objectStore(DB_STORE_NAME);
				var tmpIndex = tmpObjectStore.index(DB_INDEX);
				var openCursorRequestMax = tmpIndex.openCursor(null, 'prevunique');
				var openCursorRequestMin = tmpIndex.openCursor(null, 'nextunique');
				var maxDB_INDEX = null;
				var minDB_INDEX = null;

				openCursorRequestMax.onsuccess = function (event) {
					if (event.target.result) {
						maxDB_INDEX = event.target.result.value; //the object with max revision
						console.log("maxDB_INDEX:　"+　maxDB_INDEX.year);
						range.max = maxDB_INDEX.year;
					}
				};
				openCursorRequestMin.onsuccess = function (event) {
					if (event.target.result) {
						minDB_INDEX = event.target.result.value; //the object with max revision
						console.log("minDB_INDEX:　"+　minDB_INDEX.year);
						range.min = minDB_INDEX.year;
					}
				};
				/*tmpTransaction.oncomplete = function (event) {
					tmpDb.close();
					if(callback) //you'll need a calback function to return to your code
						callback(maxDB_INDEX);
				};*/
			}
		}
		function setValue(){
			if(settingValue){
				return;
			}
			settingValue=true;
			range.removeEventListener('mouseup', setValue);
			range.removeEventListener('touchend', setValue);
			var tmpOpenReq = indexedDB.open(DB_NAME);
				tmpOpenReq.onsuccess = function() {
					var tmpDb = tmpOpenReq.result;
					var tmpTransaction = tmpDb.transaction(DB_STORE_NAME, 'readonly');
					var tmpObjectStore = tmpTransaction.objectStore(DB_STORE_NAME);
					var tmpIndex = tmpObjectStore.index(DB_INDEX);
					const keyRng = IDBKeyRange.only(range.value);
					//var getRequest = tmpIndex.get(range.value);
					const getRequest = tmpIndex.openCursor(keyRng);
					//var tmpCounter = 0;
					var cursorCounter = 0;
					getRequest.onsuccess = function() {
						var cursor = event.target.result;
						
						//console.log(getRequest.result);
						if(cursor) {
							cursorCounter++;
							//console.log("cursor: "+ cursor);
							//tmpCounter ++;
							//console.log("cursor.value.year: "+ cursor.value.year);
							cursor.value.shipsvg = new createjs.Container();
							cursor.value.bubble = document.createElement('div');
							cursor.value.bubble.className = "bubble-container";
							var htmlp = document.createElement('p');
							htmlp.className = "triangle-isosceles";
							htmlp.innerHTML += "船名: " + cursor.value.shipname + "<br>" ;
							if (cursor.value.day){
								htmlp.innerHTML += "啟航: " +  cursor.value.year + "年" + cursor.value.month +  "月"+  cursor.value.day+"日<br>";
							}else if(cursor.value.month){
								htmlp.innerHTML += "啟航: " +  cursor.value.year + "年" + cursor.value.month +  "月<br>";
							}else{
								htmlp.innerHTML += "啟航: " +  cursor.value.year+  "年<br>";
							}
															
							if(cursor.value.nation){htmlp.innerHTML += "國籍: " + cursor.value.nation + "<br>" };
							
							if(cursor.value.caption){htmlp.innerHTML += "船長: " + cursor.value.caption + "<br>" };
							if(cursor.value.destination){htmlp.innerHTML += "目的地: " + cursor.value.destination + "<br>" };
							if(cursor.value.cules){htmlp.innerHTML += "苦力: " + cursor.value.cules + "人<br>" };
							if(cursor.value.event){htmlp.innerHTML += "事件: " + cursor.value.event + "<br>" };
							document.body.appendChild(cursor.value.bubble);
							cursor.value.bubble.appendChild(htmlp);
							var bubble = new createjs.DOMElement(cursor.value.bubble);
							switch(cursor.value.shiptype){//處理不同船形的圖片
								case "Barca":
									cursor.value.shipbitmap = new createjs.Bitmap(barca);
									htmlp.innerHTML += "船型: 三桅帆船<br>";
									break;
								case "Galera":
									cursor.value.shipbitmap = new createjs.Bitmap(galera);
									htmlp.innerHTML += "船型: 槳帆船<br>";
									break;
								case "Lorcha":
									cursor.value.shipbitmap = new createjs.Bitmap(lorcha);
									htmlp.innerHTML += "船型: 老閘船<br>";
									break;
								case "Brigue":
									cursor.value.shipbitmap = new createjs.Bitmap(brigue);
									htmlp.innerHTML += "船型: 雙桅橫帆船<br>";
									break;
								case "Vapor":
									cursor.value.shipbitmap = new createjs.Bitmap(vapor);
									htmlp.innerHTML += "船型: 輪船<br>";
									break;
								case "Escuna":
								case "Be. Escuna":
									cursor.value.shipbitmap = new createjs.Bitmap(escuna);
									htmlp.innerHTML += "船型: 雙桅縱帆船<br>";
									break;
								default:
									cursor.value.shipbitmap = new createjs.Bitmap(ship);
									break;
							}
							
							cursor.value.counter = counter;
							counter++;
							
							cursor.value.shipsvg.addChild(cursor.value.shipbitmap);
							
							cursor.value.shipsvg.addChild(bubble);
							//console.log("cursor.value.shipsvg.getChildAt(0)"+ cursor.value.shipsvg.getChildAt(0));
							//console.log("cursor.value.shipsvg.getChildAt(1)"+ cursor.value.shipsvg.getChildAt(1).className);
							stage.addChild(cursor.value.shipsvg);
							//console.log("cursor.shipsvg: "+ cursor.shipsvg);
							//stage.addChild(cursor.value.shipsvg);
							
							//console.log("cursor.value.bubble.clientWidth: "+ cursor.value.bubble.clientWidth);
							//console.log("cursor.value.bubble.clientHeight: "+ cursor.value.bubble.clientHeight);
							cursor.value.shipbitmap.regX = cursor.value.shipbitmap.image.width/2;
							cursor.value.shipbitmap.regY = 300;
							bubble.regX = cursor.value.bubble.clientWidth/2;
							bubble.regY = cursor.value.bubble.clientHeight+50;
							bubble.alpha = 0;
							cursor.value.shipsvg.alpha = 0;
							
							switch(cursor.value.specialcase){//處理不同的事件
								case "1"://船失火，170人死亡後返回澳門。
									bubble.alpha = 1;
									cursor.value.destination = "澳門";
									cursor.value.casebitmap = new createjs.Bitmap(fire);									
									cursor.value.casebitmap.regX = cursor.value.shipbitmap.image.width/2;
									cursor.value.casebitmap.regY = 300;
									cursor.value.shipsvg.addChild(cursor.value.casebitmap);
									//cursor.value.plaque = new createjs.Bitmap(plaque);
									//cursor.value.plaque.regX = cursor.value.plaque.image.width/2;
									//cursor.value.plaque.regY = (cursor.value.plaque.image.height-cursor.value.shipbitmap.image.height)/2+300;
									
									//cursor.value.shipsvg.addChild(cursor.value.plaque);
									
									break;
								case "2"://case 2: 航行230天才到古巴，276人死亡。
										
										//casetwo.onload = (cursor.value) =>{
											//console.log("cursor.value.id: "+cursor.value.id);
											bubble.alpha = 1;
											cursor.value.casebitmap = new createjs.Bitmap(casetwo);
											cursor.value.casebitmap.regX = -cursor.value.shipbitmap.image.width/4;
											cursor.value.casebitmap.regY = 300;
											cursor.value.shipsvg.addChild(cursor.value.casebitmap);
										//}
									break;
								case "3":
									bubble.alpha = 1;
									cursor.value.shipbitmap.filters = [
										 new createjs.ColorFilter(0,0.5,0,1, -255,255,-255,1),
										 new createjs.BlurFilter(10, 10, 1)
									 ];
									cursor.value.shipbitmap.cache(0, 0, cursor.value.shipbitmap.image.width,340);
									break;
								case "4":
									bubble.alpha = 1;
									cursor.value.destination = "不老灣";
									break;
								case "5":
									bubble.alpha = 1;
									cursor.value.destination = "經安直港";
									break;
								case "6":
									bubble.alpha = 1;
									cursor.value.destination = "南中國海沉沒";
									break;
							}
							getFixScale(cursor.value.shipsvg, SHIP_TO_CANVAS_RATIO);
							shiparray.push(cursor.value);
							
							cursor.value.shipsvg.addEventListener("click", () => { 
								bubble.alpha = 1;
								createjs.Tween.get(bubble).wait(2000).to({ alpha: 0 }, 1000 );

							});
							cursor.continue();
						} else {
							console.log('Entries all displayed. Total: '+cursorCounter );
							//tmpCounter = 0;
							//console.log("shiparray.toString(): "+ shiparray.toString());
							handleResize();
							
								range.addEventListener('mouseup', setValue);
								range.addEventListener('touchend', setValue);
								settingValue=false;
							
						}
					}

					/*tmpIndex.openCursor().onsuccess = function(event) {
						var cursor = event.target.result;
						if(cursor) {
							console.log("cursor: "+ cursor);
							console.log("cursor.year: "+ cursor.year);
							cursor.shipsvg = new createjs.Bitmap(ship);
							//console.log("cursor.shipsvg: "+ cursor.shipsvg);
							stage.addChild(cursor.shipsvg);
							
							getFixScale(cursor.shipsvg, SHIP_TO_CANVAS_RATIO);
							
							cursor.shipsvg.regX = 122;
							cursor.shipsvg.regY = 112;
							shiparray.push(cursor);
							
							cursor.continue();
						} else {
							console.log('Entries all displayed.');
							//console.log("shiparray.toString(): "+ shiparray.toString());
							handleResize();
						}
					};*/
				}
		}
		

		function changeValue(){

			yearTextField.innerHTML = range.value ;
			var oppArray = ["0.9", "0.8", "0.7", "0.6", "0.5", "0.4", "0.3", "0.2", "0.1", "0"];
			var tmpX = 0;
			yearTextField.style.visibility = "visible";

			(function next() {
				yearTextField.style.opacity = oppArray[tmpX];
				if(++tmpX < oppArray.length) {
					timeoutID = setTimeout(next, 100); //數字消失的速度
				}else{
					
					yearTextField.style.visibility = "hidden";
					
				}
			})();
		};
		

		document.addEventListener("DOMContentLoaded", setValue);
		range.addEventListener('mouseup', setValue);
		range.addEventListener('touchend', setValue);
		range.addEventListener('input', changeValue);
		
	}
      
	
      
</script>
	<canvas id="myCanvas" style="background-color:white;" >不支援</canvas>
	<div>
	
	</div>
	<div>

	
		<div id = "yearTextField"></div>
		<input id="range" type="range" step="1">
	
		
		
		
		<p>by inaciso 2022</p>
	</div>
</body>
</html>